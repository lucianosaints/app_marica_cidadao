<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zeladoria Maric√° Cidad√£o</title>

  <!-- Mobile & PWA Ready Tags -->
  <meta name="theme-color" content="#3498db">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- Leaflet Maps CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

  <!-- React & ReactDOM (Via CDN) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel para compilar JSX no navegador (Via CDN) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Leaflet Maps JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    html,
    body {
      overflow-x: hidden;
      width: 100%;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-image: url("logo/fundo.png");
      background-size: cover;
      background-attachment: fixed;
      background-position: center;
      padding: 10px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
    }

    .formulario-container {
      background-color: white;
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 500px;
      box-sizing: border-box;
      margin: 5px auto;
    }

    /* Media Query para Desktop */
    @media (min-width: 768px) {
      body {
        padding: 40px;
        align-items: center;
      }

      .formulario-container {
        padding: 40px;
      }
    }

    h2 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 25px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #34495e;
    }

    select,
    textarea,
    input[type="file"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 20px;
      border: 1px solid #bdc3c7;
      border-radius: 6px;
      box-sizing: border-box;
      font-family: inherit;
    }

    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
      font-size: 16px;
      font-weight: bold;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #2980b9;
    }

    button:active {
      transform: scale(0.98);
    }

    button[type="button"] {
      background-color: #2ecc71;
      margin-bottom: 10px;
    }

    button[type="button"]:hover {
      background-color: #27ae60;
    }

    .status-mensagem {
      margin-top: 20px;
      padding: 15px;
      border-radius: 6px;
      background-color: #e8f8f5;
      color: #16a085;
      text-align: center;
      font-weight: bold;
    }

    @keyframes pulse-gps {
      0% {
        transform: scale(1);
        opacity: 1;
      }

      50% {
        transform: scale(1.05);
        opacity: 0.8;
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .gps-animating {
      animation: pulse-gps 1.5s infinite ease-in-out;
      background-color: #f1c40f !important;
    }

    select:focus,
    textarea:focus {
      border-color: #3498db;
      box-shadow: 0 0 8px rgba(52, 152, 219, 0.3);
      outline: none;
    }

    .preview-foto {
      width: 100%;
      max-height: 200px;
      object-fit: cover;
      border-radius: 8px;
      margin-top: 10px;
      border: 2px solid #ecf0f1;
    }

    #map {
      height: 200px;
      width: 100%;
      border-radius: 10px;
      margin-top: 10px;
      border: 2px solid #ecf0f1;
      z-index: 1;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;

    const FormularioZeladoria = ({ token, username, onLogout, onSuccess, onBack }) => {
      const [descricao, setDescricao] = useState('');
      const [localizacao, setLocalizacao] = useState({ lat: -22.9194, lng: -42.8186 }); // Maric√° por padr√£o
      const [foto, setFoto] = useState(null);
      const [previewUrl, setPreviewUrl] = useState(null);
      const [categoria, setCategoria] = useState('');
      const [enderecoAproximado, setEnderecoAproximado] = useState('');
      const [statusEnvio, setStatusEnvio] = useState('');
      const [isCapturandoGps, setIsCapturandoGps] = useState(false);
      const [localizacaoConfirmada, setLocalizacaoConfirmada] = useState(false);

      const mapRef = React.useRef(null);
      const markerRef = React.useRef(null);

      React.useEffect(() => {
        // Inicializa o mapa
        if (!mapRef.current) {
          mapRef.current = L.map('map').setView([localizacao.lat, localizacao.lng], 13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
          }).addTo(mapRef.current);

          markerRef.current = L.marker([localizacao.lat, localizacao.lng], {
            draggable: true
          }).addTo(mapRef.current);

          markerRef.current.on('dragend', function (event) {
            const marker = event.target;
            const position = marker.getLatLng();
            setLocalizacao({
              lat: position.lat,
              lng: position.lng,
            });
            setLocalizacaoConfirmada(true);
            setStatusEnvio(''); // Limpa erro ao ajustar manualmente
          });
        }

        return () => {
          if (mapRef.current) {
            mapRef.current.remove();
            mapRef.current = null;
          }
        };
      }, []);

      const capturarLocalizacao = () => {
        setIsCapturandoGps(true);
        setStatusEnvio('üõ∞Ô∏è Buscando precis√£o do sat√©lite...');
        if ('geolocation' in navigator) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const { latitude, longitude } = position.coords;
              setLocalizacao({
                lat: latitude,
                lng: longitude,
              });

              // Atualiza o mapa e o marcador
              if (mapRef.current && markerRef.current) {
                mapRef.current.setView([latitude, longitude], 16);
                markerRef.current.setLatLng([latitude, longitude]);
              }

              setStatusEnvio('üìç Localiza√ß√£o capturada com sucesso!');
              setLocalizacaoConfirmada(true);
              setIsCapturandoGps(false);
            },
            (error) => {
              console.error("Erro no GPS:", error);
              setStatusEnvio('‚ö†Ô∏è O GPS autom√°tico falhou (comum em conex√µes n√£o-seguras). Por favor, AJUSTE O ALFINETE NO MAPA para o local correto.');
              setIsCapturandoGps(false);
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
          );
        } else {
          setStatusEnvio('‚ö†Ô∏è Geolocaliza√ß√£o n√£o suportada.');
          setIsCapturandoGps(false);
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();

        if (!localizacao.lat || !foto) {
          setStatusEnvio('Por favor, tire uma foto e capture a localiza√ß√£o via GPS.');
          return;
        }

        setStatusEnvio('Enviando relato para a prefeitura...');

        const formData = new FormData();
        formData.append('descricao', descricao);
        formData.append('categoria', categoria);
        formData.append('endereco_aproximado', enderecoAproximado);
        formData.append('latitude', parseFloat(localizacao.lat));
        formData.append('longitude', parseFloat(localizacao.lng));
        formData.append('foto_problema', foto);

        try {
          const resposta = await fetch('/api/relatos/', {
            method: 'POST',
            headers: {
              'Authorization': `Token ${token}`
            },
            body: formData,
          });

          if (resposta.ok) {
            setStatusEnvio('‚úÖ Sucesso! O problema foi relatado √† prefeitura.');
            setDescricao('');
            setEnderecoAproximado('');
            setFoto(null);
            setPreviewUrl(null);
            setCategoria('');
            if (onSuccess) onSuccess();
          } else {
            const erroData = await resposta.json();
            console.error("Erro da API:", erroData);
            // Tenta pegar a primeira mensagem de erro se dispon√≠vel
            const msgErro = Object.values(erroData)[0];
            setStatusEnvio(`‚ùå Erro: ${Array.isArray(msgErro) ? msgErro[0] : 'Verifique se todos os campos est√£o preenchidos.'}`);
          }
        } catch (erro) {
          console.error("Erro na requisi√ß√£o:", erro);
          setStatusEnvio('‚ùå Erro de conex√£o com o servidor. A API est√° rodando?');
        }
      };

      return (
        <div style={{ width: '95%', maxWidth: '450px', margin: '0 auto', paddingBottom: '20px' }}>
          {/* Header com Logos e Voltar */}
          <div style={{
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            backgroundColor: 'rgba(255,255,255,0.95)',
            padding: '8px 12px',
            borderRadius: '0 0 15px 15px',
            boxShadow: '0 2px 10px rgba(0,0,0,0.1)',
            marginBottom: '20px',
            backdropFilter: 'blur(5px)',
            width: '100%',
            boxSizing: 'border-box',
            flexWrap: 'wrap',
            gap: '8px'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
              <button onClick={onBack} style={{ width: 'auto', backgroundColor: '#95a5a6', padding: '4px 8px', fontSize: '12px' }}>‚Üê</button>
              <div style={{ display: 'flex', gap: '5px' }}>
                <img src="logo/Logo-prefeitura.png" alt="P" style={{ height: '22px' }} />
                <img src="logo/Logo-Ictim.png" alt="I" style={{ height: '22px' }} />
              </div>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
              <span style={{ fontWeight: '600', color: '#2c3e50', fontSize: '12px' }}>Ol√°, <strong>{username || 'Cidad√£o'}</strong></span>
              <button type="button" onClick={onLogout} style={{ width: 'auto', backgroundColor: '#e74c3c', padding: '5px 10px', fontSize: '11px', borderRadius: '15px' }}>Sair</button>
            </div>
          </div>

          <div className="formulario-container" style={{ width: '100%', maxWidth: '100%', padding: '25px 20px', margin: '0 auto' }}>
            <h1 style={{ color: '#2c3e50', margin: '0 0 10px 0', fontSize: '20px', textAlign: 'center' }}>Novo Relato de Zeladoria</h1>
            <p style={{ color: '#7f8c8d', marginBottom: '25px', textAlign: 'center', fontSize: '14px' }}>Preencha os dados abaixo para informar um problema √† prefeitura.</p>

            <form onSubmit={handleSubmit} style={{ display: 'flex', flexDirection: 'column', gap: '25px' }}>
              <div style={{ backgroundColor: '#f8f9fa', padding: '20px', borderRadius: '12px', border: '1px solid #edf2f7' }}>
                <label style={{ display: 'block', marginBottom: '8px', fontWeight: 'bold', color: '#34495e' }}>üè¢ O que voc√™ quer reportar?</label>
                <select
                  value={categoria}
                  onChange={(e) => setCategoria(e.target.value)}
                  required
                  style={{ width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid #dcdde1', fontSize: '16px', backgroundColor: 'white' }}
                >
                  <option value="">Selecione uma categoria...</option>
                  <option value="1">üõ§Ô∏è Buraco na Via</option>
                  <option value="2">üí° L√¢mpada Queimada</option>
                  <option value="3">ü¶ü Foco de Dengue</option>
                  <option value="4">üå≥ Poda de √Årvore</option>
                  <option value="5">üóëÔ∏è Ac√∫mulo de Lixo</option>
                </select>
              </div>

              <div>
                <label style={{ display: 'block', marginBottom: '8px', fontWeight: 'bold', color: '#34495e' }}>üìù Descreva o problema:</label>
                <textarea
                  value={descricao}
                  onChange={(e) => setDescricao(e.target.value)}
                  placeholder="Seja o mais espec√≠fico poss√≠vel para ajudar a equipe t√©cnica..."
                  style={{ width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid #dcdde1', fontSize: '15px', minHeight: '100px', outline: 'none', transition: 'box-shadow 0.3s' }}
                  required
                />
              </div>

              <div>
                <label style={{ display: 'block', marginBottom: '8px', fontWeight: 'bold', color: '#34495e' }}>üìç Onde √© o problema?</label>
                <textarea
                  value={enderecoAproximado}
                  onChange={(e) => setEnderecoAproximado(e.target.value)}
                  placeholder="Avenida principal, em frente √† loja tal..."
                  style={{ width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid #dcdde1', fontSize: '15px', minHeight: '60px', outline: 'none', transition: 'box-shadow 0.3s' }}
                  required
                />
              </div>

              <div style={{ display: 'grid', gridTemplateColumns: '1fr', gap: '15px' }}>
                <div style={{ backgroundColor: '#fdfdfd', padding: '15px', borderRadius: '10px', border: '1px dashed #cbd5e0' }}>
                  <label style={{ display: 'block', marginBottom: '8px', fontWeight: 'bold', color: '#34495e' }}>üì∏ Foto do Local:</label>
                  <input
                    type="file"
                    accept="image/*"
                    onChange={(e) => {
                      const file = e.target.files[0];
                      setFoto(file);
                      if (file) {
                        const url = URL.createObjectURL(file);
                        setPreviewUrl(url);
                      }
                    }}
                    style={{ fontSize: '12px', marginBottom: '10px', width: '100%' }}
                    required
                  />
                  {previewUrl && <img src={previewUrl} className="preview-foto" alt="Preview" />}
                </div>
                <div style={{ textAlign: 'center', backgroundColor: '#fdfdfd', padding: '15px', borderRadius: '10px', border: '1px dashed #cbd5e0', display: 'flex', flexDirection: 'column', gap: '10px' }}>
                  <label style={{ display: 'block', marginBottom: '8px', fontWeight: 'bold', color: '#34495e' }}>üõ∞Ô∏è Localiza√ß√£o GPS:</label>
                  <button
                    type="button"
                    onClick={capturarLocalizacao}
                    className={isCapturandoGps ? 'gps-animating' : ''}
                    style={{ width: '100%', backgroundColor: '#2ecc71', fontSize: '14px', padding: '15px', borderRadius: '8px', transition: 'all 0.3s' }}
                    disabled={isCapturandoGps}
                  >
                    {isCapturandoGps ? '‚åõ Sincronizando...' : 'üìç Capturar Meu Local'}
                  </button>

                  <div id="map"></div>
                  <p style={{ fontSize: '10px', color: '#7f8c8d', margin: '5px 0' }}>
                    Ajuste o alfinete azul no mapa para o local exato.
                  </p>

                  {localizacaoConfirmada && !isCapturandoGps && <p style={{ margin: '0', fontSize: '11px', color: '#27ae60', fontWeight: 'bold' }}>
                    ‚úÖ Localiza√ß√£o Fixada!
                  </p>}
                </div>
              </div>

              <div style={{ borderTop: '2px solid #f7fafc', paddingTop: '20px', marginTop: '10px' }}>
                <button
                  type="submit"
                  style={{
                    fontSize: '18px',
                    padding: '18px',
                    fontWeight: 'bold',
                    backgroundColor: '#0097e6',
                    boxShadow: '0 4px 15px rgba(0, 151, 230, 0.4)',
                    borderRadius: '10px'
                  }}
                >
                  üöÄ Enviar Relato √† Prefeitura
                </button>
                {statusEnvio && <div style={{
                  textAlign: 'center',
                  marginTop: '15px',
                  padding: '10px',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: 'bold',
                  backgroundColor: statusEnvio.includes('Erro') || statusEnvio.includes('‚ùå') ? '#fff5f5' : '#f0fff4',
                  color: statusEnvio.includes('Erro') || statusEnvio.includes('‚ùå') ? '#c53030' : '#2f855a',
                  border: `1px solid ${statusEnvio.includes('Erro') || statusEnvio.includes('‚ùå') ? '#feb2b2' : '#9ae6b4'}`
                }}>
                  {statusEnvio}
                </div>}
              </div>
            </form>
          </div>
        </div>
      );
    };

    const Cadastro = ({ onCadastroSuccess, onBackToLogin }) => {
      const [username, setUsername] = useState('');
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [firstName, setFirstName] = useState('');
      const [lastName, setLastName] = useState('');
      const [cpf, setCpf] = useState('');
      const [telefone, setTelefone] = useState('');
      const [dataNascimento, setDataNascimento] = useState('');
      const [cep, setCep] = useState('');
      const [logradouro, setLogradouro] = useState('');
      const [numero, setNumero] = useState('');
      const [bairro, setBairro] = useState('');
      const [cidade, setCidade] = useState('Maric√°');
      const [comprovante, setComprovante] = useState(null);

      const [status, setStatus] = useState('');
      const [isLoading, setIsLoading] = useState(false);

      const handleCadastro = async (e) => {
        e.preventDefault();
        setIsLoading(true);
        setStatus('Criando sua conta...');

        const formData = new FormData();
        formData.append('username', username);
        formData.append('email', email);
        formData.append('password', password);
        formData.append('first_name', firstName);
        formData.append('last_name', lastName);
        formData.append('cpf', cpf);
        formData.append('telefone', telefone);
        formData.append('data_nascimento', dataNascimento);
        formData.append('cep', cep);
        formData.append('logradouro', logradouro);
        formData.append('numero', numero);
        formData.append('bairro', bairro);
        formData.append('cidade', cidade);
        if (comprovante) {
          formData.append('comprovante_titularidade', comprovante);
        }

        try {
          const resposta = await fetch('/api/cadastro/', {
            method: 'POST',
            body: formData
          });

          if (resposta.ok) {
            setStatus('‚úÖ Conta criada com sucesso! Redirecionando para o login...');
            setTimeout(() => {
              onCadastroSuccess();
            }, 2000);
          } else {
            const data = await resposta.json();
            console.error("Erro no cadastro:", data);
            setStatus(`‚ùå Erro: ${JSON.stringify(data)}`);
          }
        } catch (err) {
          console.error("Erro de conex√£o detalhado:", err);
          setStatus(`‚ùå Erro de conex√£o com o servidor. Verifique o terminal do backend. (Erro: ${err.message})`);
        } finally {
          setIsLoading(false);
        }
      };

      return (
        <div className="formulario-container">
          <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', marginBottom: '20px' }}>
            <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', gap: '10px', marginBottom: '15px', flexWrap: 'wrap' }}>
              <img src="logo/Logo-prefeitura.png" alt="Prefeitura" style={{ height: '35px', maxWidth: '140px', objectFit: 'contain' }} />
              <img src="logo/Logo-Ictim.png" alt="Ictim" style={{ height: '35px', maxWidth: '140px', objectFit: 'contain' }} />
            </div>
            <h2 style={{ margin: 0, color: '#2c3e50', fontSize: '20px', textAlign: 'center' }}>Cadastro de Cidad√£o</h2>
            <p style={{ margin: '5px 0 0', color: '#7f8c8d', fontSize: '13px', textAlign: 'center' }}>Crie sua conta completa para acessar os servi√ßos.</p>
          </div>

          <form onSubmit={handleCadastro} style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>
            {/* Dados de Acesso */}
            <div style={{ backgroundColor: '#f8f9fa', padding: '15px', borderRadius: '10px', border: '1px solid #e9ecef' }}>
              <h3 style={{ margin: '0 0 10px 0', fontSize: '14px', color: '#3498db' }}>üîê Dados de Acesso</h3>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                <input type="text" value={username} onChange={e => setUsername(e.target.value)} placeholder="Usu√°rio (Login)" required disabled={isLoading} style={{ width: '100%', padding: '10px', borderRadius: '6px', border: '1px solid #dcdde1' }} />
                <input type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder="E-mail" required disabled={isLoading} style={{ width: '100%', padding: '10px', borderRadius: '6px', border: '1px solid #dcdde1' }} />
                <input type="password" value={password} onChange={e => setPassword(e.target.value)} placeholder="Senha" required disabled={isLoading} style={{ width: '100%', padding: '10px', borderRadius: '6px', border: '1px solid #dcdde1' }} />
              </div>
            </div>

            {/* Dados Pessoais */}
            <div style={{ backgroundColor: '#f8f9fa', padding: '15px', borderRadius: '10px', border: '1px solid #e9ecef' }}>
              <h3 style={{ margin: '0 0 10px 0', fontSize: '14px', color: '#3498db' }}>üë§ Dados Pessoais</h3>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '10px' }}>
                <input type="text" value={firstName} onChange={e => setFirstName(e.target.value)} placeholder="Nome" required disabled={isLoading} style={{ width: '100%', padding: '10px', borderRadius: '6px', border: '1px solid #dcdde1' }} />
                <input type="text" value={lastName} onChange={e => setLastName(e.target.value)} placeholder="Sobrenome" required disabled={isLoading} style={{ width: '100%', padding: '10px', borderRadius: '6px', border: '1px solid #dcdde1' }} />
              </div>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '10px', marginTop: '10px' }}>
                <input type="text" value={cpf} onChange={e => setCpf(e.target.value)} placeholder="CPF (000.000.000-00)" required disabled={isLoading} style={{ width: '100%', padding: '10px', borderRadius: '6px', border: '1px solid #dcdde1' }} />
                <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap', marginTop: '10px' }}>
                  <input type="text" value={telefone} onChange={e => setTelefone(e.target.value)} placeholder="Telefone" disabled={isLoading} style={{ flex: '1 1 180px', padding: '10px', borderRadius: '6px', border: '1px solid #dcdde1' }} />
                  <input type="date" value={dataNascimento} onChange={e => setDataNascimento(e.target.value)} title="Data de Nascimento" disabled={isLoading} style={{ flex: '1 1 180px', padding: '10px', borderRadius: '6px', border: '1px solid #dcdde1' }} />
                </div>
              </div>
            </div>

            {/* Endere√ßo */}
            <div style={{ backgroundColor: '#f8f9fa', padding: '15px', borderRadius: '10px', border: '1px solid #e9ecef' }}>
              <h3 style={{ margin: '0 0 10px 0', fontSize: '14px', color: '#3498db' }}>üè† Endere√ßo</h3>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(130px, 1fr))', gap: '10px' }}>
                <input type="text" value={cep} onChange={e => setCep(e.target.value)} placeholder="CEP" disabled={isLoading} style={{ width: '100%', padding: '10px', borderRadius: '6px', border: '1px solid #dcdde1' }} />
                <input type="text" value={logradouro} onChange={e => setLogradouro(e.target.value)} placeholder="Rua/Logradouro" disabled={isLoading} style={{ width: '100%', padding: '10px', borderRadius: '6px', border: '1px solid #dcdde1' }} />
              </div>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(130px, 1fr))', gap: '10px', marginTop: '10px' }}>
                <input type="text" value={numero} onChange={e => setNumero(e.target.value)} placeholder="N¬∫" disabled={isLoading} style={{ width: '100%', padding: '10px', borderRadius: '6px', border: '1px solid #dcdde1' }} />
                <input type="text" value={bairro} onChange={e => setBairro(e.target.value)} placeholder="Bairro" disabled={isLoading} style={{ width: '100%', padding: '10px', borderRadius: '6px', border: '1px solid #dcdde1' }} />
              </div>
              <input type="text" value={cidade} onChange={e => setCidade(e.target.value)} placeholder="Cidade" disabled={isLoading} style={{ width: '100%', marginTop: '10px', padding: '10px', borderRadius: '6px', border: '1px solid #dcdde1' }} />
            </div>

            {/* Comprovante */}
            <div style={{ backgroundColor: '#f8f9fa', padding: '15px', borderRadius: '10px', border: '1px solid #e9ecef' }}>
              <h3 style={{ margin: '0 0 10px 0', fontSize: '14px', color: '#3498db' }}>üìÑ Comprovante de Im√≥vel (Opcional)</h3>
              <input type="file" onChange={e => setComprovante(e.target.files[0])} disabled={isLoading} style={{ width: '100%', fontSize: '12px' }} />
              <p style={{ margin: '5px 0 0', fontSize: '10px', color: '#95a5a6' }}>Caso a a√ß√£o seja em local privado.</p>
            </div>

            <div style={{ marginTop: '10px', display: 'flex', flexDirection: 'column', gap: '12px' }}>
              <button type="submit" disabled={isLoading} style={{ padding: '15px', fontSize: '18px', fontWeight: 'bold', backgroundColor: '#2ecc71', color: 'white', borderRadius: '10px', border: 'none', cursor: 'pointer', boxShadow: '0 4px 10px rgba(46, 204, 113, 0.3)' }}>
                {isLoading ? '‚åõ Cadastrando...' : 'Finalizar Cadastro üöÄ'}
              </button>
              <button type="button" onClick={onBackToLogin} style={{ backgroundColor: 'transparent', color: '#7f8c8d', border: '1px solid #dcdde1', padding: '10px', borderRadius: '8px', fontSize: '14px', cursor: 'pointer' }} disabled={isLoading}>
                J√° tenho conta. Voltar ao Login
              </button>
            </div>
          </form>

          {status && <div className="status-mensagem" style={{ marginTop: '20px', padding: '12px', borderRadius: '8px', fontSize: '14px', fontWeight: 'bold', textAlign: 'center', backgroundColor: status.includes('‚ùå') ? '#fff5f5' : '#f0fff4', color: status.includes('‚ùå') ? '#c53030' : '#2f855a', border: `1px solid ${status.includes('‚ùå') ? '#feb2b2' : '#9ae6b4'}` }}>{status}</div>}
        </div>
      );
    };


    const Login = ({ onLoginSuccess, onGoToCadastro }) => {
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [erro, setErro] = useState('');

      const handleLogin = async (e) => {
        e.preventDefault();
        setErro('Autenticando...');

        try {
          const resposta = await fetch('/api/login/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username, password })
          });

          if (resposta.ok) {
            const data = await resposta.json();
            onLoginSuccess(data.token, data.username);
          } else {
            setErro('Acesso Negado. Cidad√£o n√£o encontrado ou senha incorreta.');
          }
        } catch (err) {
          setErro('Erro ao se conectar com o sistema da Prefeitura.');
        }
      };

      return (
        <div className="formulario-container" style={{ padding: '0', overflow: 'hidden' }}>
          <div style={{
            backgroundImage: 'url("logo/Montagem_Ilustracao_Prefeitura-d.png")',
            backgroundSize: 'cover',
            backgroundPosition: 'center',
            height: '140px',
            width: '100%'
          }}></div>
          <div style={{ padding: '25px' }}>
            <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', gap: '15px', marginBottom: '20px' }}>
              <img src="logo/Logo-prefeitura.png" alt="P" style={{ height: '40px' }} />
              <img src="logo/Logo-Ictim.png" alt="I" style={{ height: '40px' }} />
            </div>
            <h2 style={{ marginTop: 0, fontSize: '20px', color: '#2c3e50' }}>Maric√° Cidad√£o</h2>
            <form onSubmit={handleLogin} style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>
              <div>
                <label style={{ fontSize: '14px', marginBottom: '5px' }}>üë§ CPF ou Usu√°rio:</label>
                <input
                  type="text"
                  value={username}
                  onChange={e => setUsername(e.target.value)}
                  placeholder="Seu CPF ou nome"
                  required
                  style={{ width: '100%', padding: '12px', border: '1px solid #dcdde1', borderRadius: '8px', outline: 'none' }}
                />
              </div>
              <div>
                <label style={{ fontSize: '14px', marginBottom: '5px' }}>üîí Senha:</label>
                <input
                  type="password"
                  value={password}
                  onChange={e => setPassword(e.target.value)}
                  placeholder="Sua senha segura"
                  required
                  style={{ width: '100%', padding: '12px', border: '1px solid #dcdde1', borderRadius: '8px', outline: 'none' }}
                />
              </div>
              <button
                type="submit"
                style={{
                  padding: '15px',
                  backgroundColor: '#0097e6',
                  boxShadow: '0 4px 10px rgba(0, 151, 230, 0.3)',
                  marginTop: '10px'
                }}
              >
                Login üöÄ
              </button>
              <button
                type="button"
                onClick={onGoToCadastro}
                style={{
                  backgroundColor: 'transparent',
                  color: '#7f8c8d',
                  border: '1px solid #dcdde1',
                  padding: '10px',
                  fontSize: '14px'
                }}
              >
                N√£o tem conta? Cadastre-se
              </button>
            </form>
            {erro && <div className="status-mensagem" style={{ backgroundColor: '#fff5f5', color: '#c53030', border: '1px solid #feb2b2', padding: '10px', fontSize: '13px' }}>{erro}</div>}
          </div>
        </div>
      );
    };

    const DashboardCidadao = ({ token, username, onLogout, onChangeView }) => {
      const [relatos, setRelatos] = useState([]);
      const [carregando, setCarregando] = useState(true);
      const [erro, setErro] = useState('');

      React.useEffect(() => {
        const carregarRelatos = async () => {
          try {
            const resposta = await fetch('/api/relatos/', {
              headers: { 'Authorization': `Token ${token}` }
            });
            if (resposta.ok) {
              const data = await resposta.json();
              setRelatos(data);
            } else {
              setErro('Erro ao carregar relatos.');
            }
          } catch (err) {
            setErro('Erro de conex√£o com o servidor.');
          } finally {
            setCarregando(false);
          }
        };
        carregarRelatos();
      }, [token]);

      const getStatusColor = (status) => {
        const cores = {
          'recebido': '#f39c12',
          'em_analise': '#3498db',
          'equipe_despachada': '#9b59b6',
          'resolvido': '#2ecc71',
          'rejeitado': '#e74c3c'
        };
        return cores[status] || '#95a5a6';
      };

      const stats = {
        total: relatos.length,
        resolvidos: relatos.filter(r => r.status_atual === 'resolvido').length,
        em_andamento: relatos.filter(r => r.status_atual !== 'resolvido' && r.status_atual !== 'rejeitado').length
      };

      return (
        <div style={{ width: '95%', maxWidth: '450px', margin: '0 auto', paddingBottom: '30px' }}>
          {/* Header Superior com Logos */}
          <div style={{
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            backgroundColor: 'rgba(255,255,255,0.98)',
            padding: '10px 15px',
            borderRadius: '0 0 15px 15px',
            boxShadow: '0 4px 12px rgba(0,0,0,0.08)',
            marginBottom: '25px',
            backdropFilter: 'blur(8px)',
            width: '100%',
            boxSizing: 'border-box',
            borderBottom: '2px solid #3498db',
            flexWrap: 'wrap',
            gap: '8px'
          }}>
            <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>
              <img src="logo/Logo-prefeitura.png" alt="P" style={{ height: '26px' }} />
              <img src="logo/Logo-Ictim.png" alt="I" style={{ height: '26px' }} />
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
              <span style={{ fontWeight: '700', color: '#2c3e50', fontSize: '12px' }}>Ol√°, {username || 'Cidad√£o'}</span>
              <button
                type="button"
                onClick={onLogout}
                style={{
                  width: 'auto',
                  backgroundColor: '#ee5253',
                  padding: '5px 12px',
                  fontSize: '11px',
                  borderRadius: '15px',
                  boxShadow: '0 2px 4px rgba(238, 82, 83, 0.3)'
                }}
              >
                Sair
              </button>
            </div>
          </div>

          {/* Banner de Boas-vindas e A√ß√£o Principal */}
          <div style={{
            backgroundColor: 'white',
            padding: '30px 20px',
            borderRadius: '15px',
            boxShadow: '0 6px 20px rgba(0,0,0,0.06)',
            marginBottom: '30px',
            textAlign: 'center',
            backgroundImage: 'linear-gradient(135deg, #ffffff 0%, #f1f2f6 100%)',
            width: '100%',
            boxSizing: 'border-box'
          }}>
            <h1 style={{ color: '#2c3e50', margin: '0 0 10px 0', fontSize: '24px', fontWeight: '800' }}>Central de Zeladoria</h1>
            <p style={{ color: '#7f8c8d', marginBottom: '25px', fontSize: '15px' }}>Transforme Maric√° cuidando do seu bairro.</p>
            <button
              onClick={() => onChangeView('novo')}
              style={{
                width: '100%',
                maxWidth: '300px',
                padding: '18px',
                fontSize: '18px',
                fontWeight: 'bold',
                backgroundColor: '#0097e6',
                boxShadow: '0 5px 15px rgba(0, 151, 230, 0.4)',
                borderRadius: '12px',
                border: 'none',
                color: 'white',
                cursor: 'pointer'
              }}
            >
              üöÄ Abrir Novo Chamado
            </button>
          </div>

          {/* Grid de Estat√≠sticas - Responsivo */}
          <div style={{
            display: 'grid',
            gridTemplateColumns: 'repeat(auto-fit, minmax(130px, 1fr))',
            gap: '15px',
            marginBottom: '30px',
            padding: '0 5px'
          }}>
            <div style={{ backgroundColor: 'white', padding: '18px 10px', borderRadius: '15px', textAlign: 'center', boxShadow: '0 3px 10px rgba(0,0,0,0.04)', borderBottom: '4px solid #3498db' }}>
              <div style={{ fontSize: '28px', fontWeight: '800', color: '#3498db', marginBottom: '4px' }}>{stats.total}</div>
              <div style={{ color: '#95a5a6', fontSize: '11px', textTransform: 'uppercase', fontWeight: '700', letterSpacing: '0.8px' }}>Total</div>
            </div>
            <div style={{ backgroundColor: 'white', padding: '18px 10px', borderRadius: '15px', textAlign: 'center', boxShadow: '0 3px 10px rgba(0,0,0,0.04)', borderBottom: '4px solid #f39c12' }}>
              <div style={{ fontSize: '28px', fontWeight: '800', color: '#f39c12', marginBottom: '4px' }}>{stats.em_andamento}</div>
              <div style={{ color: '#95a5a6', fontSize: '11px', textTransform: 'uppercase', fontWeight: '700', letterSpacing: '0.8px' }}>Abertos</div>
            </div>
            <div style={{ backgroundColor: 'white', padding: '18px 10px', borderRadius: '15px', textAlign: 'center', boxShadow: '0 3px 10px rgba(0,0,0,0.04)', borderBottom: '4px solid #2ecc71' }}>
              <div style={{ fontSize: '28px', fontWeight: '800', color: '#2ecc71', marginBottom: '4px' }}>{stats.resolvidos}</div>
              <div style={{ color: '#95a5a6', fontSize: '11px', textTransform: 'uppercase', fontWeight: '700', letterSpacing: '0.8px' }}>Resolvidos</div>
            </div>
          </div>

          {/* Listagem de Protocolos */}
          <div style={{ marginBottom: '20px', padding: '0 5px' }}>
            <h2 style={{ color: 'white', margin: 0, textShadow: '1px 2px 4px rgba(0,0,0,0.2)', fontSize: '22px', fontWeight: '700' }}>Meus Protocolos Ativos</h2>
          </div>

          {carregando && <div style={{ backgroundColor: 'white', padding: '50px', borderRadius: '15px', textAlign: 'center', boxShadow: '0 4px 15px rgba(0,0,0,0.05)' }}>
            <p style={{ fontSize: '18px', color: '#7f8c8d' }}>Sincronizando com a prefeitura... ‚è≥</p>
          </div>}

          {erro && <div className="status-mensagem" style={{ backgroundColor: '#fff5f5', color: '#c53030', border: '1px solid #feb2b2' }}>{erro}</div>}

          {!carregando && relatos.length === 0 && !erro && (
            <div style={{ backgroundColor: 'white', padding: '50px 30px', borderRadius: '15px', textAlign: 'center', boxShadow: '0 8px 25px rgba(0,0,0,0.05)', border: '1px solid #f1f2f6' }}>
              <div style={{ fontSize: '60px', marginBottom: '20px', filter: 'grayscale(0.5)' }}>üìã</div>
              <h3 style={{ margin: '0 0 10px 0', color: '#2c3e50', fontSize: '20px', fontWeight: '700' }}>Nenhum relato encontrado</h3>
              <p style={{ color: '#95a5a6', fontSize: '15px', maxWidth: '300px', margin: '0 auto' }}>Voc√™ ainda n√£o abriu nenhum chamado para a prefeitura. Comece agora ajudando sua cidade!</p>
            </div>
          )}

          <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
            {relatos.map(relato => (
              <div key={relato.id} style={{
                backgroundColor: 'white',
                padding: '25px',
                borderRadius: '15px',
                boxShadow: '0 5px 15px rgba(0,0,0,0.1)',
                transition: 'transform 0.2s',
                cursor: 'pointer'
              }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', borderBottom: '1px solid #f0f0f0', paddingBottom: '15px', marginBottom: '15px' }}>
                  <div>
                    <span style={{
                      display: 'inline-block',
                      backgroundColor: '#f1f2f6',
                      color: '#57606f',
                      padding: '3px 10px',
                      borderRadius: '5px',
                      fontSize: '12px',
                      fontWeight: 'bold',
                      marginBottom: '8px'
                    }}>
                      #{relato.id}
                    </span>
                    <h3 style={{ margin: '0', color: '#2c3e50', fontSize: '18px' }}>{relato.categoria_nome}</h3>
                    <div style={{ marginTop: '5px', color: '#95a5a6', fontSize: '13px' }}>
                      üìÖ Aberto em {new Date(relato.criado_em).toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' })}
                    </div>
                  </div>
                  <div style={{ textAlign: 'right' }}>
                    <div style={{
                      backgroundColor: getStatusColor(relato.status_atual),
                      color: 'white',
                      padding: '6px 15px',
                      borderRadius: '20px',
                      fontSize: '13px',
                      fontWeight: 'bold',
                      boxShadow: '0 2px 5px rgba(0,0,0,0.1)'
                    }}>
                      {relato.status_display || relato.status_atual.toUpperCase()}
                    </div>
                  </div>
                </div>

                <div style={{ color: '#2f3542', fontSize: '15px', lineHeight: '1.6', marginBottom: '20px' }}>
                  {relato.descricao}
                </div>

                {relato.historico && relato.historico.length > 0 ? (
                  <div style={{ backgroundColor: '#f8f9fa', padding: '15px', borderRadius: '10px', border: '1px dashed #dcdde1' }}>
                    <h4 style={{ margin: '0 0 12px 0', color: '#747d8c', fontSize: '13px', fontWeight: 'bold' }}>üìç √öLTIMA ATUALIZA√á√ÉO DA PREFEITURA</h4>
                    <div style={{ position: 'relative', paddingLeft: '15px' }}>
                      <div style={{ position: 'absolute', left: 0, top: 0, bottom: 0, width: '3px', backgroundColor: '#3498db', borderRadius: '10px' }}></div>
                      <div style={{ fontSize: '14px', color: '#2c3e50' }}>
                        {relato.historico[0].observacao_prefeitura}
                      </div>
                      <small style={{ display: 'block', marginTop: '5px', color: '#a4b0be' }}>
                        Atualizado em {new Date(relato.historico[0].data_atualizacao).toLocaleDateString()}
                      </small>
                    </div>
                  </div>
                ) : (
                  <div style={{ color: '#a4b0be', fontSize: '13px', fontStyle: 'italic' }}>
                    Aguardando an√°lise da secretaria competente.
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      );
    };

    const AppWrapper = () => {
      const [token, setToken] = useState(localStorage.getItem('marica_token') || null);
      const [username, setUsername] = useState(localStorage.getItem('marica_username') || '');
      const [view, setView] = useState('lista'); // 'lista' ou 'novo'
      const [isRegistering, setIsRegistering] = useState(false);

      const handleLogin = (newToken, newUsername) => {
        localStorage.setItem('marica_token', newToken);
        localStorage.setItem('marica_username', newUsername);
        setToken(newToken);
        setUsername(newUsername);
        setView('lista');
      };

      const handleLogout = () => {
        localStorage.removeItem('marica_token');
        localStorage.removeItem('marica_username');
        setToken(null);
        setUsername('');
        setIsRegistering(false);
      };

      if (!token) {
        if (isRegistering) {
          return <Cadastro onCadastroSuccess={() => setIsRegistering(false)} onBackToLogin={() => setIsRegistering(false)} />
        }
        return <Login onLoginSuccess={handleLogin} onGoToCadastro={() => setIsRegistering(true)} />
      }

      if (view === 'novo') {
        return <FormularioZeladoria token={token} username={username} onLogout={handleLogout} onSuccess={() => setView('lista')} onBack={() => setView('lista')} />;
      }

      return <DashboardCidadao token={token} username={username} onLogout={handleLogout} onChangeView={setView} />
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<AppWrapper />);
  </script>
</body>

</html>