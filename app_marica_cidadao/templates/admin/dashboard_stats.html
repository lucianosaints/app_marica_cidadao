{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style>
    :root {
        --primary: #3498db;
        --success: #2ecc71;
        --warning: #f39c12;
        --danger: #e74c3c;
        --dark: #2c3e50;
        --light: #f4f6f9;
        --glass: rgba(255, 255, 255, 0.8);
    }

    body {
        background-color: #f4f7f6;
        font-family: 'Inter', sans-serif;
    }

    .dashboard-container {
        padding: 20px;
    }

    .kpi-card {
        border: none;
        border-radius: 15px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        overflow: hidden;
        margin-bottom: 20px;
        background: white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    .kpi-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .kpi-card .card-body {
        padding: 25px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .kpi-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
    }

    .kpi-info h3 {
        margin: 0;
        font-weight: 700;
        font-size: 2rem;
        color: var(--dark);
    }

    .kpi-info p {
        margin: 0;
        color: #7f8c8d;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 1px;
    }

    .chart-card {
        border: none;
        border-radius: 15px;
        background: white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        margin-bottom: 30px;
        height: 100%;
    }

    .chart-card .card-header {
        background: transparent;
        border-bottom: 1px solid #eee;
        padding: 20px;
    }

    .chart-card .card-title {
        font-weight: 600;
        color: var(--dark);
        margin: 0;
    }

    /* Gradients for icons */
    .bg-grad-blue {
        background: linear-gradient(135deg, #3498db, #2980b9);
    }

    .bg-grad-green {
        background: linear-gradient(135deg, #2ecc71, #27ae60);
    }

    .bg-grad-orange {
        background: linear-gradient(135deg, #f39c12, #e67e22);
    }

    .bg-grad-purple {
        background: linear-gradient(135deg, #9b59b6, #8e44ad);
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="row">
        <div class="col-12 mb-4">
            <h1 class="h3 mb-0 text-gray-800">ðŸ“Š Central de InteligÃªncia Urbana - MaricÃ¡</h1>
            <p class="text-muted small">Monitoramento em tempo real da zeladoria citadina</p>
        </div>
    </div>

    <!-- KPI Row -->
    <div class="row">
        <div class="col-xl-3 col-md-6">
            <div class="kpi-card">
                <div class="card-body">
                    <div class="kpi-info">
                        <p>Total de Relatos</p>
                        <h3>{{ total_relatos }}</h3>
                    </div>
                    <div class="kpi-icon bg-grad-blue">
                        <i class="fas fa-bullhorn"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="kpi-card">
                <div class="card-body">
                    <div class="kpi-info">
                        <p>Resolvidos</p>
                        <h3>{{ resolvidos }}</h3>
                    </div>
                    <div class="kpi-icon bg-grad-green">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="kpi-card">
                <div class="card-body">
                    <div class="kpi-info">
                        <p>Em Andamento</p>
                        <h3>{{ em_andamento }}</h3>
                    </div>
                    <div class="kpi-icon bg-grad-purple">
                        <i class="fas fa-tools"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="kpi-card">
                <div class="card-body">
                    <div class="kpi-info">
                        <p>Pendentes / Novos</p>
                        <h3>{{ pendentes }}</h3>
                    </div>
                    <div class="kpi-icon bg-grad-orange">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row">
        <!-- EvoluÃ§Ã£o Temporal -->
        <div class="col-lg-8">
            <div class="chart-card">
                <div class="card-header">
                    <h5 class="card-title">EvoluÃ§Ã£o dos Relatos (Ãšltimos 30 Dias)</h5>
                </div>
                <div class="card-body">
                    <canvas id="evolucaoChart" style="height: 350px;"></canvas>
                </div>
            </div>
        </div>

        <!-- DistribuiÃ§Ã£o por Status -->
        <div class="col-lg-4">
            <div class="chart-card">
                <div class="card-header">
                    <h5 class="card-title">Status dos Chamados</h5>
                </div>
                <div class="card-body">
                    <canvas id="statusChart" style="height: 350px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <!-- Top Categorias -->
        <div class="col-12">
            <div class="chart-card">
                <div class="card-header">
                    <h5 class="card-title">Volume por Categoria de Problema</h5>
                </div>
                <div class="card-body">
                    <canvas id="categoriaChart" style="height: 300px; width: 100%;"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Cores suaves e profissionais
        const colors = {
            blue: '#3498db',
            green: '#2ecc71',
            purple: '#9b59b6',
            orange: '#f39c12',
            red: '#e74c3c',
            gray: '#95a5a6'
        };

        // 1. GrÃ¡fico de EvoluÃ§Ã£o (Linha)
        const evolData = {{ evolucao_stats_json| safe
    }};
    new Chart(document.getElementById('evolucaoChart'), {
        type: 'line',
        data: {
            labels: evolData.map(d => d.data),
            datasets: [{
                label: 'Novos Relatos',
                data: evolData.map(d => d.total),
                borderColor: colors.blue,
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } },
                x: { grid: { display: false } }
            }
        }
    });

    // 2. GrÃ¡fico de Status (Doughnut)
    const statusRaw = {{ status_stats_json| safe }};
    const statusLabelsMap = {
        'recebido': 'Pendente',
        'em_progresso': 'Em ExecuÃ§Ã£o',
        'resolvido': 'Resolvido',
        'arquivado': 'Arquivado'
    };
    const statusColorsMap = {
        'recebido': colors.orange,
        'em_progresso': colors.purple,
        'resolvido': colors.green,
        'arquivado': colors.gray
    };

    new Chart(document.getElementById('statusChart'), {
        type: 'doughnut',
        data: {
            labels: statusRaw.map(s => statusLabelsMap[s.status_atual] || s.status_atual),
            datasets: [{
                data: statusRaw.map(s => s.total),
                backgroundColor: statusRaw.map(s => statusColorsMap[s.status_atual] || colors.blue),
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });

    // 3. GrÃ¡fico de Categorias (Barras Horizontais)
    const catData = {{ categoria_stats_json| safe }};
    new Chart(document.getElementById('categoriaChart'), {
        type: 'bar',
        data: {
            labels: catData.map(c => c.categoria__nome),
            datasets: [{
                label: 'Quantidade',
                data: catData.map(c => c.total),
                backgroundColor: colors.blue + '80', // semi-transparent
                borderColor: colors.blue,
                borderWidth: 1,
                borderRadius: 8
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { beginAtZero: true, ticks: { stepSize: 1 } },
                y: { grid: { display: false } }
            }
        }
    });
    });
</script>
{% endblock %}